<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NIET Student Check-In/Out</title>
<style>
  :root{
    --brand:#704E9A;
    --brand-dark:#5c3c81;
    --ok:#118a0a; --warn:#d97706; --err:#b91c1c;
    --checkout:#dc2626; --checkout-dark:#b91c1c;
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;}
  body{
    margin:0;color:#111;
    background:linear-gradient(135deg,#704E9A 0%,#5563DE 100%);
    min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;
  }
  .wrap{width:100%;max-width:600px;}
  .card{
    background:#fff;border-radius:20px;padding:40px 28px;
    box-shadow:0 18px 40px rgba(0,0,0,.15);
  }
  h1{
    margin:0 0 14px;font-size:28px;text-align:center;
    background:linear-gradient(90deg,#704E9A,#5563DE);
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    font-weight:800;
  }
  .muted{color:#555;font-size:14px;margin:0 0 20px;text-align:center;}
  label{display:block;margin:14px 0 8px;font-weight:600;}
  input,select,button{
    width:100%;padding:14px 16px;border:1px solid #d8dee9;border-radius:12px;background:#fff;font-size:16px;
  }
  input:focus,select:focus{
    outline:none;border-color:var(--brand);
    box-shadow:0 0 0 4px rgba(112,78,154,.10);
  }
  button{
    border:none;font-weight:700;cursor:pointer;
    transition:all .2s ease;font-size:16px;padding:14px;
  }
  button[disabled]{background:#d5cce3;cursor:not-allowed;color:#fff;}
  
  /* Button Row Container */
  .button-row{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
    margin-top:20px;
  }
  
  /* Check In Button */
  .btn-checkin{
    background:var(--brand);
    color:#fff;
  }
  .btn-checkin:hover:not([disabled]){
    background:var(--brand-dark);
    transform:translateY(-2px);
    box-shadow:0 4px 12px rgba(112,78,154,.3);
  }
  
  /* Check Out Button */
  .btn-checkout{
    background:var(--checkout);
    color:#fff;
  }
  .btn-checkout:hover:not([disabled]){
    background:var(--checkout-dark);
    transform:translateY(-2px);
    box-shadow:0 4px 12px rgba(220,38,38,.3);
  }
  
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
  .msg{margin-top:16px;padding:14px;border-radius:12px;font-size:15px;display:none;}
  .msg.ok{display:block;background:#ecfdf5;color:var(--ok);border:1px solid #bbf7d0;}
  .msg.warn{display:block;background:#fffbeb;color:var(--warn);border:1px solid #fde68a;}
  .msg.err{display:block;background:#fef2f2;color:var(--err);border:1px solid #fecaca;}
  .msg.info{display:block;background:#eff6ff;color:#2563eb;border:1px solid #bfdbfe;}
  .footer{text-align:center;margin-top:18px;color:#6b7280;font-size:12px;}
  
  /* Session Info Display */
  .session-info{
    background:#f8f9fa;
    border-radius:12px;
    padding:16px;
    margin-top:16px;
    display:none;
  }
  .session-info.active{display:block;}
  .session-header{
    font-weight:700;
    color:var(--brand);
    margin-bottom:12px;
    font-size:15px;
    display:flex;
    align-items:center;
    gap:8px;
  }
  .status-badge{
    display:inline-block;
    background:#22c55e;
    color:#fff;
    padding:4px 10px;
    border-radius:12px;
    font-size:11px;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:0.5px;
  }
  .session-row{
    display:flex;
    justify-content:space-between;
    padding:6px 0;
    font-size:14px;
  }
  .session-label{color:#6b7280;}
  .session-value{font-weight:600;color:#111;}
  .time-display{
    text-align:center;
    font-size:36px;
    font-weight:800;
    color:var(--brand);
    margin:12px 0;
    font-variant-numeric:tabular-nums;
    letter-spacing:-1px;
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Student Attendance System</h1>
      <p class="muted">Please allow location. Your GPS is used only to verify you are on campus.</p>

      <form onsubmit="return false;">
        <label for="studentId">Student ID</label>
        <input id="studentId" inputmode="numeric" pattern="[0-9]*" placeholder="e.g. 13579666" required autofocus />

        <label for="name">Full Name</label>
        <input id="name" placeholder="e.g. Wilson So" required />

        <div class="row">
          <div>
            <label for="trainer">Trainer</label>
            <select id="trainer" required>
              <option value="">— Select trainer —</option>
            </select>
          </div>
          <div>
            <label for="course">Course</label>
            <select id="course" required>
              <option value="">— Select course —</option>
            </select>
          </div>
        </div>

        <!-- Side by Side Buttons -->
        <div class="button-row">
          <button type="button" id="btnCheckIn" class="btn-checkin" disabled onclick="submitCheckIn()">
            ➜ Check In
          </button>
          <button type="button" id="btnCheckOut" class="btn-checkout" disabled onclick="submitCheckOut()">
            ✓ Check Out
          </button>
        </div>
      </form>

      <!-- Session Info Panel -->
      <div id="sessionInfo" class="session-info">
        <div class="session-header">
          <span class="status-badge">Active Session</span>
        </div>
        <div class="session-row">
          <span class="session-label">Checked in at:</span>
          <span class="session-value" id="sessionCheckIn">-</span>
        </div>
        <div class="session-row">
          <span class="session-label">Campus:</span>
          <span class="session-value" id="sessionCampus">-</span>
        </div>
        <div class="time-display" id="timeElapsed">00:00:00</div>
      </div>

      <div id="msg" class="msg"></div>
      <div class="footer">© NIET Attendance</div>
    </div>
  </div>

<script>
/* CONFIG */
const CHECKIN_FLOW_URL = "https://default9d8868a5c1dc4786aff1f7d04646be.9a.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/9ed041ac7ca143a0b262334d9dfc13d5/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=il-cX-qHDZbGSxE2OnN56BK2jdJIgxWXFIStUm65G6g";
const CHECKOUT_FLOW_URL = "https://default9d8868a5c1dc4786aff1f7d04646be.9a.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/2e4266def4fe44618e9eddd28221178c/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=NfMkFq1ITZSPcQNVmn6Ikt7OPS0NUA_Yp-Q9QP8TFoQ"
const ID_REGEX = /^(?:[Ss][0-9]{6,}|[0-9]{6,10})$/;

/* All available courses */
const ALL_COURSES = [
  "BSB40120 Certificate IV in Business",
  "BSB50120 Diploma of Business UniTrack",
  "BSB50420 Diploma of Leadership and Management",
  "BSB80120 Graduate Diploma of Management (Learning) UniTrack",
  "SIT30821 Certificate III in Commercial Cookery",
  "SIT40521 Certificate IV in Kitchen Management",
  "SIT50422 Diploma of Hospitality Management",
  "ICT50220 Diploma of Information Technology",
  "ICT60220 Advanced Diploma of Information Technology (Telecommunications Network Engineering)",
  "CHC43015 Certificate IV in Ageing Support",
  "CHC33021 Certificate III in Individual Support",
  "CHC52021 Diploma of Community Services",
  "CHC30121 Certificate III in Early Childhood Education and Care",
  "CHC50121 Diploma of Early Childhood Education and Care",
  "HLT52021 Diploma of Remedial Massage",
  "RII60520 Advanced Diploma of Civil Construction"
];

/* Trainers and their courses */
const TRAINER_COURSES = {
  "Carlos Castellano": ["SIT30821 Certificate III in Commercial Cookery"],
  "Richard LIM": ["BSB80120 Graduate Diploma of Management (Learning) UniTrack"],
  "Toriqul Mozumder": ["CHC33021 Certificate III in Individual Support", "CHC52021 Diploma of Community Services"],
  "Carol Ly": ["CHC43015 Certificate IV in Ageing Support"],
  "Marc Bishop": ["SIT40521 Certificate IV in Kitchen Management"],
  "Matthew Facey": ["BSB50420 Diploma of Leadership and Management"],
  "Ruying Shao": ["SIT50422 Diploma of Hospitality Management"],
  "Sherwin Thiarhia": ["CHC33021 Certificate III in Individual Support", "CHC43015 Certificate IV in Ageing Support"],
  "John Black": ["SIT30821 Certificate III in Commercial Cookery", "SIT40521 Certificate IV in Kitchen Management"],
  "John Owen": ["SIT50422 Diploma of Hospitality Management"],
  "Nicole Hicks": ["CHC30121 Certificate III in Early Childhood Education and Care", "CHC50121 Diploma of Early Childhood Education and Care"],
  "Niral Joshi": ["BSB50120 Diploma of Business UniTrack", "BSB80120 Graduate Diploma of Management (Learning) UniTrack"],
  "Tanya Caterson": ["SIT30821 Certificate III in Commercial Cookery"],
  "Zeyun Kylie MA": ["BSB50420 Diploma of Leadership and Management"],
  "Fei Yu": ["CHC50121 Diploma of Early Childhood Education and Care"],
  "Chloe BIAN": ["CHC50121 Diploma of Early Childhood Education and Care", "CHC30121 Certificate III in Early Childhood Education and Care"],
  "Edwin Zywko-Hicks": ["BSB80120 Graduate Diploma of Management (Learning) UniTrack"],
  "Gunther Zywko-Hicks": ["SIT50422 Diploma of Hospitality Management"],
  "Jan Cisler": ["HLT52021 Diploma of Remedial Massage"],
  "Li Tang": ["CHC30121 Certificate III in Early Childhood Education and Care"],
  "Marty Gray": ["BSB50120 Diploma of Business UniTrack", "BSB50420 Diploma of Leadership and Management", "BSB80120 Graduate Diploma of Management (Learning) UniTrack"],
  "Pelin Tatlidil": ["ICT50220 Diploma of Information Technology"],
  "Ranimary": ["CHC52021 Diploma of Community Services"],
  "Robert Sauer": ["SIT30821 Certificate III in Commercial Cookery", "SIT40521 Certificate IV in Kitchen Management"],
  "Rona": ["SIT30821 Certificate III in Commercial Cookery", "SIT40521 Certificate IV in Kitchen Management"],
  "Peter Ng": ["RII60520 Advanced Diploma of Civil Construction"]
};

/* Default if trainer not listed */
const OTHER_TRAINERS = ["Lily YE","Nati","Peter NG"];
OTHER_TRAINERS.forEach(t=>TRAINER_COURSES[t]=ALL_COURSES);

/* Campus zones */
const CAMPUS_ZONES = [
  { name:"Brisbane Campus 102 Adelaide Street", lat:-27.468069512085428, lng:153.02471942376695, radius:300 },
  { name:"Brisbane Campus 316 Adelaide Street", lat:-27.465055267670685, lng:153.02871827605486, radius:300 },
  { name:"Gold Coast Campus", lat:-27.945401908916576, lng:153.41147360207012, radius:300 },
  { name:"Hobart Campus", lat:-42.884889723708625, lng:147.32545454150238, radius:300 }
];

/* ELEMENTS */
const elId=document.getElementById('studentId');
const elName=document.getElementById('name');
const elTrainer=document.getElementById('trainer');
const elCourse=document.getElementById('course');
const elBtnCheckIn=document.getElementById('btnCheckIn');
const elBtnCheckOut=document.getElementById('btnCheckOut');
const elMsg=document.getElementById('msg');
const elSessionInfo=document.getElementById('sessionInfo');
const elSessionCampus=document.getElementById('sessionCampus');
const elSessionCheckIn=document.getElementById('sessionCheckIn');
const elTimeElapsed=document.getElementById('timeElapsed');

/* Session state */
let activeSession = null;
let timerInterval = null;

/* Populate trainers */
(function initDropdowns(){
  Object.keys(TRAINER_COURSES).forEach(t=>{
    const o=document.createElement('option');o.value=t;o.textContent=t;elTrainer.appendChild(o);
  });
})();

elTrainer.addEventListener('change',()=>{
  const courses = TRAINER_COURSES[elTrainer.value] || ALL_COURSES;
  elCourse.innerHTML="";
  ["— Select course —",...courses].forEach((c,i)=>{
    const o=document.createElement('option');o.value=i?c:"";o.textContent=c;elCourse.appendChild(o);
  });
});

/* GPS */
let latestLat=null,latestLng=null,gpsReady=false,detectedCampus=null;

function distanceMeters(lat1,lng1,lat2,lng2){
  const toRad=x=>x*Math.PI/180;
  const x=(toRad(lng2-lng1))*Math.cos(toRad((lat1+lat2)/2));
  const y=toRad(lat2-lat1);
  return Math.sqrt(x*x+y*y)*6371000;
}

function detectCampus(lat,lng){
  let best=null;
  for(const c of CAMPUS_ZONES){
    const d=distanceMeters(lat,lng,c.lat,c.lng);
    if(d<=c.radius && (!best||d<best.d))best={...c,d};
  }
  return best;
}

function updateButtonStates(){
  const formValid = elId.value.trim() && 
                    elName.value.trim() && 
                    elTrainer.value && 
                    elCourse.value && 
                    ID_REGEX.test(elId.value.trim());
  
  // Check In button: enabled when form valid, GPS ready, and NO active session
  elBtnCheckIn.disabled = !(formValid && gpsReady && !activeSession);
  
  // Check Out button: enabled when form valid, GPS ready, and HAS active session
  elBtnCheckOut.disabled = !(formValid && gpsReady && activeSession);
}

['input','change'].forEach(evt=>[elId,elName,elTrainer,elCourse].forEach(el=>el.addEventListener(evt,updateButtonStates)));

function startGPS(){
  if(!('geolocation'in navigator)){setMsg('Your device does not support GPS.','err');return;}
  navigator.geolocation.getCurrentPosition(
    pos=>{
      latestLat=pos.coords.latitude;latestLng=pos.coords.longitude;
      detectedCampus=detectCampus(latestLat,latestLng);
      if(!detectedCampus){
        gpsReady=false;
        updateButtonStates();
        setMsg('❌ You are not within any campus area.','err');
        return;
      }
      gpsReady=true;
      updateButtonStates();
      if(!activeSession){
        setMsg('✓ GPS ready. You can now check in.','ok');
      }
    },
    err=>{
      gpsReady=false;
      updateButtonStates();
      setMsg('⚠️ Location permission is required.','warn');
    },
    {enableHighAccuracy:true,timeout:15000,maximumAge:0}
  );
}

/* Message display */
function setMsg(text,kind){
  elMsg.className='msg '+(kind||'ok');
  elMsg.textContent=text;
  elMsg.style.display='block';
}

/* Session Management */
function loadActiveSession(){
  const saved = localStorage.getItem('activeSession');
  if(saved){
    try{
      activeSession = JSON.parse(saved);
      
      // Populate form with saved session data
      elId.value = activeSession.studentId;
      elName.value = activeSession.name;
      elTrainer.value = activeSession.trainer;
      
      // Trigger trainer change to populate courses
      elTrainer.dispatchEvent(new Event('change'));
      
      // Wait a moment for courses to populate, then set course
      setTimeout(()=>{
        elCourse.value = activeSession.course;
        updateButtonStates();
      }, 50);
      
      showSessionInfo();
      startTimer();
      setMsg('Active session resumed. Fill in your details and click "Check Out" when done.','info');
    }catch(e){
      localStorage.removeItem('activeSession');
    }
  }
}

function saveActiveSession(){
  localStorage.setItem('activeSession', JSON.stringify(activeSession));
}

function clearActiveSession(){
  localStorage.removeItem('activeSession');
  activeSession = null;
  if(timerInterval){
    clearInterval(timerInterval);
    timerInterval = null;
  }
}

function showSessionInfo(){
  elSessionInfo.classList.add('active');
  elSessionCampus.textContent = activeSession.campus;
  elSessionCheckIn.textContent = new Date(activeSession.checkInTime).toLocaleTimeString('en-AU', {
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: true
  });
}

function hideSessionInfo(){
  elSessionInfo.classList.remove('active');
}

/* Timer */
function formatTime(seconds){
  const h = Math.floor(seconds / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  const s = seconds % 60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function startTimer(){
  if(timerInterval) clearInterval(timerInterval);
  
  function updateTimer(){
    if(!activeSession) return;
    const elapsed = Math.floor((Date.now() - activeSession.checkInTime) / 1000);
    elTimeElapsed.textContent = formatTime(elapsed);
  }
  
  updateTimer();
  timerInterval = setInterval(updateTimer, 1000);
}

/* Check In */
async function submitCheckIn(){
  const id=(elId.value||'').trim();
  const name=(elName.value||'').trim();
  const trainer=elTrainer.value;
  const course=elCourse.value;
  
  elMsg.style.display='none';
  
  if(!ID_REGEX.test(id)){setMsg('Please enter a valid Student ID.','warn');return;}
  if(!gpsReady||latestLat===null||latestLng===null){setMsg('Location not ready. Try again.','warn');startGPS();return;}
  if(!detectedCampus){setMsg('You are not on an NIET campus.','err');return;}
  if(activeSession){setMsg('⚠️ You already have an active session. Please check out first.','warn');return;}

  elBtnCheckIn.disabled=true;
  elBtnCheckIn.textContent='Checking In…';
  
  try{
    const checkInTime = Date.now();
    const res=await fetch(CHECKIN_FLOW_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        StudentID:id,
        Name:name,
        Trainer:trainer,
        Course:course,
        Campus:detectedCampus.name,
        Latitude:latestLat,
        Longitude:latestLng,
        CheckInTime: new Date(checkInTime).toISOString()
      })
    });
    
    const data=await res.json().catch(()=>({}));
    
    if(res.ok){
      activeSession = {
        studentId: id,
        name: name,
        trainer: trainer,
        course: course,
        campus: detectedCampus.name,
        checkInTime: checkInTime,
        checkInLat: latestLat,
        checkInLng: latestLng
      };
      
      saveActiveSession();
      showSessionInfo();
      startTimer();
      updateButtonStates();
      setMsg('✅ Checked in successfully! Timer started.','ok');
    }else{
      setMsg('❌ '+(data.message||`Check-in failed (${res.status}).`),'err');
    }
  }catch(e){
    setMsg('❌ Network error. Please try again.','err');
  }finally{
    elBtnCheckIn.disabled=false;
    elBtnCheckIn.textContent='➜ Check In';
    updateButtonStates();
  }
}

/* Check Out */
async function submitCheckOut(){
  const id=(elId.value||'').trim();
  const name=(elName.value||'').trim();
  const trainer=elTrainer.value;
  const course=elCourse.value;
  
  if(!activeSession){
    setMsg('❌ No active session. Please check in first.','err');
    return;
  }
  
  // Verify form data matches active session
  if(id.toUpperCase() !== activeSession.studentId.toUpperCase()){
    setMsg('❌ Student ID does not match active session.','err');
    return;
  }
  
  elMsg.style.display='none';
  
  if(!gpsReady){
    setMsg('⚠️ Getting your location for checkout...','warn');
    startGPS();
    setTimeout(()=>{
      if(gpsReady) submitCheckOut();
    }, 2000);
    return;
  }
  
  elBtnCheckOut.disabled=true;
  elBtnCheckOut.textContent='Checking Out…';
  
  try{
    const checkOutTime = Date.now();
    const durationSeconds = Math.floor((checkOutTime - activeSession.checkInTime) / 1000);
    const durationMinutes = Math.floor(durationSeconds / 60);
    const hours = Math.floor(durationMinutes / 60);
    const minutes = durationMinutes % 60;
    
    const res=await fetch(CHECKOUT_FLOW_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        StudentID: activeSession.studentId,
        Name: activeSession.name,
        Trainer: activeSession.trainer,
        Course: activeSession.course,
        Campus: activeSession.campus,
        CheckInTime: new Date(activeSession.checkInTime).toISOString(),
        CheckOutTime: new Date(checkOutTime).toISOString(),
        CheckInLatitude: activeSession.checkInLat,
        CheckInLongitude: activeSession.checkInLng,
        CheckOutLatitude: latestLat,
        CheckOutLongitude: latestLng,
        DurationSeconds: durationSeconds,
        DurationMinutes: durationMinutes,
        DurationFormatted: `${hours}h ${minutes}m`
      })
    });
    
    const data=await res.json().catch(()=>({}));
    
    if(res.ok){
      setMsg(`✅ Checked out successfully! Time in class: ${hours}h ${minutes}m`,'ok');
      clearActiveSession();
      hideSessionInfo();
      
      // Clear form
      elId.value = '';
      elName.value = '';
      elTrainer.value = '';
      elCourse.innerHTML = '<option value="">— Select course —</option>';
      
      updateButtonStates();
    }else{
      setMsg('❌ '+(data.message||`Check-out failed (${res.status}).`),'err');
    }
  }catch(e){
    setMsg('❌ Network error. Please try again.','err');
  }finally{
    elBtnCheckOut.disabled=false;
    elBtnCheckOut.textContent='✓ Check Out';
    updateButtonStates();
  }
}

/* Initialize */
startGPS();
loadActiveSession();
</script>
</body>
</html>
